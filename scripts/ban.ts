//원본 코드 : var _0xfac0=["\x75\x73\x65\x20\x73\x74\x72\x69\x63\x74","\x5F\x5F\x65\x73\x4D\x6F\x64\x75\x6C\x65","\x64\x65\x66\x69\x6E\x65\x50\x72\x6F\x70\x65\x72\x74\x79","\x62\x64\x73\x78\x2F\x62\x64\x73\x2F\x70\x6C\x61\x79\x65\x72","\x62\x64\x73\x78\x2F\x63\x6F\x6D\x6D\x61\x6E\x64","\x62\x64\x73\x78\x2F\x65\x76\x65\x6E\x74","\x62\x64\x73\x78\x2F\x6C\x61\x75\x6E\x63\x68\x65\x72","\x63\x6F\x6C\x6F\x72\x73","\x66\x73","\x2E\x2E\x2F\x6D\x61\x69\x6E","\x2E\x2E\x2F\x4E\x43\x42\x50\x62\x61\x6E\x4C\x69\x73\x74","\x65\x78\x69\x73\x74\x73\x53\x79\x6E\x63","\x6D\x6B\x64\x69\x72\x53\x79\x6E\x63","\x67\x65\x74\x43\x6C\x69\x65\x6E\x74\x49\x64","\x70\x72\x6F\x74\x6F\x74\x79\x70\x65","\x50\x6C\x61\x79\x65\x72","\x67\x65\x74\x4E\x61\x6D\x65\x54\x61\x67","\x72\x65\x61\x64\x64\x69\x72\x53\x79\x6E\x63","\x69\x6E\x63\x6C\x75\x64\x65\x73","\x2E\x2E\x2F\x4E\x43\x42\x50\x62\x61\x6E\x6C\x69\x73\x74\x2F","\x72\x65\x61\x64\x46\x69\x6C\x65\x53\x79\x6E\x63","\x3A","\x73\x70\x6C\x69\x74","","\x67\x65\x74\x56\x61\x6C\x75\x65\x73","\x7C","\x63\x6F\x6E\x6E\x72\x65\x71","\x67\x65\x74\x43\x65\x72\x74\x69\x66\x69\x63\x61\x74\x65","\x67\x65\x74\x49\x64","\x67\x65\x74\x4A\x73\x6F\x6E\x56\x61\x6C\x75\x65","\x67\x65\x74\x44\x65\x76\x69\x63\x65\x4F\x53","\x44\x65\x76\x69\x63\x65\x4D\x6F\x64\x65\x6C","\x67\x65\x74\x41\x64\x64\x72\x65\x73\x73","\x6C\x65\x6E\x67\x74\x68","\x67\x65\x74\x58\x75\x69\x64","\x67\x65\x74\x50\x65\x72\x6D\x69\x73\x73\x69\x6F\x6E\x4C\x65\x76\x65\x6C","\x4F\x50\x45\x52\x41\x54\x4F\x52","\x50\x6C\x61\x79\x65\x72\x50\x65\x72\x6D\x69\x73\x73\x69\x6F\x6E","\x66\x69\x6C\x74\x65\x72","\x67\x65\x74\x50\x6C\x61\x79\x65\x72\x73","\x73\x65\x72\x76\x65\x72\x49\x6E\x73\x74\x61\x6E\x63\x65","\x62\x65\x64\x72\x6F\x63\x6B\x53\x65\x72\x76\x65\x72","\x2E\x2E\x2F\x4E\x43\x42\x50\x62\x61\x6E\x4C\x69\x73\x74\x2F","\x41\x6B\x69\x6E\x45\x72\x6D\x69\x6E\x65\x31\x34\x39\x35\x37","\xA7\x6C\x5B\xA7\x63\x4E\x43\x42\x50\xA7\x66\x5D\x20\x42\x61\x6E\x20\x3A\x20","\x28","\x29\x28\uC774\x29\uAC00\x20\uC811\uC18D\uC744\x20\uC2DC\uB3C4\uD588\uC2B5\uB2C8\uB2E4\x20\x5B","\x2C\x20\x4E\x43\x42\x50\x20\x41\x75\x74\x6F\x20\x42\x61\x6E\x5D\x20\x28\uC811\uC18D\uC2DC\uAC04\x20\x3A\x20","\x64\x61\x74\x65\x57\x69\x74\x68\x5A\x65\x72\x6F","\x29","\x73\x65\x6E\x64\x4D\x65\x73\x73\x61\x67\x65","\x20\x74\x72\x69\x65\x64\x20\x74\x6F\x20\x63\x6F\x6E\x6E\x65\x63\x74\x20\x5B","\x5D\x20\x28\x4E\x43\x42\x50\x20\x41\x75\x74\x6F\x20\x42\x61\x6E\x29","\x72\x65\x64","\x69\x6E\x66\x6F","\xA7\x6C\x5B\xA7\x63\x4E\x43\x42\x50\xA7\x66\x5D\x20\xA7\x65\x42\x61\x6E\x6E\x65\x64\x20\x3A\x20\x55\x6E\x66\x61\x69\x72\x20\x41\x64\x76\x61\x6E\x74\x61\x67\x65","\x64\x69\x73\x63\x6F\x6E\x6E\x65\x63\x74\x43\x6C\x69\x65\x6E\x74","\x6F\x6E","\x70\x61\x63\x6B\x65\x74\x41\x66\x74\x65\x72","\x65\x76\x65\x6E\x74\x73","\x62\x61\x6E\x2D\x6D\x61\x6E\x61\x67\x65","\x4D\x61\x6E\x61\x67\x65\x73\x20\x61\x62\x6F\x75\x74\x20\x4E\x43\x42\x50\x20\x41\x75\x74\x6F\x20\x42\x61\x6E","\x72\x65\x67\x69\x73\x74\x65\x72","\x63\x6F\x6D\x6D\x61\x6E\x64","\x73\x6F\x66\x74\x45\x6E\x75\x6D","\x20\x20\uC11C\uBC84\x20\uCC28\uB2E8\uC744\x20\uD574\uC81C\uD560\x20\uD50C\uB808\uC774\uC5B4\uB97C\x20\uC120\uD0DD\uD574\uC8FC\uC138\uC694\x20\x20","\x61\x64\x64\x56\x61\x6C\x75\x65\x73","\x62\x61\x6E","\x77\x72\x69\x74\x65\x46\x69\x6C\x65\x53\x79\x6E\x63","\x67\x65\x74\x45\x6E\x74\x69\x74\x79","\x70\x75\x73\x68","\x69\x73\x53\x65\x72\x76\x65\x72\x43\x6F\x6D\x6D\x61\x6E\x64\x4F\x72\x69\x67\x69\x6E","\x4E\x43\x42\x50\x20\x41\x75\x74\x6F\x20\x42\x61\x6E\x20\x3A\x20","\x79\x65\x6C\x6C\x6F\x77","\xA7\x65\x4E\x43\x42\x50\x20\x41\x75\x74\x6F\x20\x42\x61\x6E\x20\x3A\x20\xA7\x66","\x6C\x69\x73\x74","\x65\x6E\x75\x6D","\x6F\x76\x65\x72\x6C\x6F\x61\x64","\x70\x6C\x61\x79\x65\x72","\uC11C\uBC84\x20\uCC28\uB2E8\uC744\x20\uD574\uC81C\uD560\x20\uD50C\uB808\uC774\uC5B4\uB97C\x20\uC120\uD0DD\uD574\uC8FC\uC138\uC694","\uC65C\x20\uC774\uAC78\x20\uCC28\uB2E8\x20\uD574\uC81C\x20\uD558\uC2DC\uB824\uB294\uAC70\uC8E0\x3F","\x65\x72\x72\x6F\x72","\uB294\x20\x4E\x43\x42\x50\x20\x41\x6E\x74\x69\x63\x68\x65\x61\x74\uC5D0\x20\uC758\uD55C\x20\uBC34\uC774\x20\uB418\uC5B4\uC788\uC9C0\x20\uC54A\uC2B5\uB2C8\uB2E4","\xA7\x63","\x75\x6E\x6C\x69\x6E\x6B\x53\x79\x6E\x63","\uB97C\x20\uC131\uACF5\uC801\uC73C\uB85C\x20\uCC28\uB2E8\x20\uD574\uC81C\x20\uD588\uC2B5\uB2C8\uB2E4","\x67\x72\x65\x65\x6E","\xA7\x61","\x72\x65\x6D\x6F\x76\x65\x56\x61\x6C\x75\x65\x73","\x75\x6E\x62\x61\x6E","\x73\x65\x72\x76\x65\x72\x4F\x70\x65\x6E"];_0xfac0[0];Object[_0xfac0[2]](exports,_0xfac0[1],{value:true});const player_1=require(_0xfac0[3]);const command_1=require(_0xfac0[4]);const event_1=require(_0xfac0[5]);const launcher_1=require(_0xfac0[6]);const colors_1=require(_0xfac0[7]);const fs_1=require(_0xfac0[8]);const main_1=require(_0xfac0[9]);if(!(0,fs_1[_0xfac0[11]])(_0xfac0[10])){(0,fs_1[_0xfac0[12]])(_0xfac0[10])};const ClientId={};const port={};const portBan={};let UnbanEnum;;;player_1[_0xfac0[15]][_0xfac0[14]][_0xfac0[13]]= function(){return ClientId[this[_0xfac0[16]]()]};function isBanned(cid,port,plname,xboxLogined){const _0xd5d8x10=(0,fs_1[_0xfac0[17]])(_0xfac0[10]);reloadValue();if(_0xd5d8x10[_0xfac0[18]](cid)|| portBan[port]== true){return true}else {for(const _0xd5d8x11 of _0xd5d8x10){const _0xd5d8x12=(0,fs_1[_0xfac0[20]])(_0xfac0[19]+ _0xd5d8x11).toString();const _0xd5d8x13=_0xd5d8x12[_0xfac0[22]](_0xfac0[21])[0];if(_0xd5d8x13=== _0xfac0[23]){return false};if(UnbanEnum[_0xfac0[24]]()[_0xfac0[18]](plname)){if(_0xd5d8x13!== plname){continue};const xlogined=Boolean(_0xd5d8x12[_0xfac0[22]](_0xfac0[25])[1]);if(xlogined=== xboxLogined){return true}else {return false};;}else {return false};;};;;return false};;}let reloadValue=(()=>{});event_1[_0xfac0[59]][_0xfac0[58]](1)[_0xfac0[57]]((pkt,ni)=>{const _0xd5d8x18=pkt[_0xfac0[26]];if(!_0xd5d8x18){return};const _0xd5d8x19=_0xd5d8x18[_0xfac0[27]]();const plname=_0xd5d8x19[_0xfac0[28]]();let cid=String(_0xd5d8x18[_0xfac0[29]]().ClientRandomId);if(_0xd5d8x18[_0xfac0[30]]()=== 7){cid= _0xd5d8x18[_0xfac0[29]]()[_0xfac0[31]]};port[plname]= ni[_0xfac0[32]]()[_0xfac0[22]](_0xfac0[25])[1];ClientId[plname]= cid;reloadValue();if(isBanned(cid,ni[_0xfac0[32]]()[_0xfac0[22]](_0xfac0[25])[1],plname,_0xd5d8x19[_0xfac0[34]]()[_0xfac0[33]]> 2)=== true){const onlineops=launcher_1[_0xfac0[41]][_0xfac0[40]][_0xfac0[39]]()[_0xfac0[38]]((p)=>{return p[_0xfac0[35]]()=== player_1[_0xfac0[37]][_0xfac0[36]]});let reason;const _0xd5d8x10=(0,fs_1[_0xfac0[17]])(_0xfac0[42]);if(!_0xd5d8x10[_0xfac0[18]](cid)){reason= _0xfac0[43]}else {reason= String((0,fs_1[_0xfac0[20]])(_0xfac0[42]+ cid))[_0xfac0[22]](_0xfac0[21])[1];if(reason[_0xfac0[18]](_0xfac0[25])){reason= reason[_0xfac0[22]](_0xfac0[25])[0]}};;;const _0xd5d8x12=(0,fs_1[_0xfac0[20]])(_0xfac0[19]+ cid).toString();const _0xd5d8x13=_0xd5d8x12[_0xfac0[22]](_0xfac0[21])[0];for(const pl of onlineops){pl[_0xfac0[50]](`${_0xfac0[44]}${plname}${_0xfac0[45]}${_0xd5d8x13}${_0xfac0[46]}${reason}${_0xfac0[47]}${(0,main_1[_0xfac0[48]])()}${_0xfac0[49]}`)};;;(0,main_1[_0xfac0[54]])((0,colors_1[_0xfac0[53]])(`${_0xfac0[23]}${plname}${_0xfac0[51]}${reason}${_0xfac0[52]}`));launcher_1[_0xfac0[41]][_0xfac0[40]][_0xfac0[56]](ni,`${_0xfac0[55]}`);reloadValue()}});event_1[_0xfac0[59]][_0xfac0[90]][_0xfac0[57]](()=>{const _0xd5d8x1e=command_1[_0xfac0[63]][_0xfac0[62]](_0xfac0[60],_0xfac0[61],1);UnbanEnum= command_1[_0xfac0[63]][_0xfac0[64]](_0xfac0[15]);UnbanEnum[_0xfac0[66]](_0xfac0[65]);player_1[_0xfac0[15]][_0xfac0[14]][_0xfac0[67]]= function(reason){const pl=this;const plname=pl[_0xfac0[16]]();const cid=ClientId[plname];portBan[port[plname]]= true;(0,fs_1[_0xfac0[68]])(_0xfac0[42]+ cid,plname+ _0xfac0[21]+ reason+ _0xfac0[25]+ `${_0xfac0[23]}${pl[_0xfac0[34]]()[_0xfac0[33]]> 2}${_0xfac0[23]}`);reloadValue()};reloadValue= (()=>{const _0xd5d8x10=(0,fs_1[_0xfac0[17]])(_0xfac0[42]);for(const _0xd5d8x1f of _0xd5d8x10){const _0xd5d8x11=(0,fs_1[_0xfac0[20]])(_0xfac0[42]+ _0xd5d8x1f).toString();const split=_0xd5d8x11[_0xfac0[22]](_0xfac0[21]);const _0xd5d8x13=split[0];UnbanEnum[_0xfac0[66]](_0xd5d8x13);ClientId[_0xd5d8x13]= _0xd5d8x1f};;});reloadValue();_0xd5d8x1e[_0xfac0[77]]((p,o,op)=>{const pl=o[_0xfac0[69]]();const _0xd5d8x10=(0,fs_1[_0xfac0[17]])(_0xfac0[42]);const _0xd5d8x23=[];for(let _0xd5d8x11 of _0xd5d8x10){_0xd5d8x11= (0,fs_1[_0xfac0[20]])(_0xfac0[42]+ _0xd5d8x11).toString();const split=_0xd5d8x11[_0xfac0[22]](_0xfac0[21]);const _0xd5d8x13=split[0];const reason=split[1];_0xd5d8x23[_0xfac0[70]](`${_0xfac0[23]}${_0xd5d8x13}${_0xfac0[45]}${reason}${_0xfac0[49]}`)};;;reloadValue();if(o[_0xfac0[71]]()){(0,main_1[_0xfac0[54]])((0,colors_1[_0xfac0[73]])(`${_0xfac0[72]}${_0xd5d8x23}${_0xfac0[23]}`))}else {pl[_0xfac0[50]](_0xfac0[74]+ _0xd5d8x23)};;;return 0},{list:command_1[_0xfac0[63]][_0xfac0[76]](_0xfac0[75],_0xfac0[75])});_0xd5d8x1e[_0xfac0[77]]((p,o,op)=>{const pl=o[_0xfac0[69]]();const bannedpl=UnbanEnum[_0xfac0[24]]();const cid=ClientId[p[_0xfac0[78]]];if(p[_0xfac0[78]]=== _0xfac0[79]){op[_0xfac0[81]](_0xfac0[80]);return};reloadValue();if(!bannedpl[_0xfac0[18]](p[_0xfac0[78]])){if(o[_0xfac0[71]]()){(0,main_1[_0xfac0[54]])((0,colors_1[_0xfac0[53]])(`${_0xfac0[23]}${p[_0xfac0[78]]}${_0xfac0[82]}`))}else {pl[_0xfac0[50]](`${_0xfac0[83]}${p[_0xfac0[78]]}${_0xfac0[82]}`)};;;return};(0,fs_1[_0xfac0[84]])(_0xfac0[42]+ cid);if(o[_0xfac0[71]]()){(0,main_1[_0xfac0[54]])((0,colors_1[_0xfac0[86]])(`${_0xfac0[23]}${p[_0xfac0[78]]}${_0xfac0[85]}`))}else {pl[_0xfac0[50]](`${_0xfac0[87]}${p[_0xfac0[78]]}${_0xfac0[85]}`)};;;portBan[port[p[_0xfac0[78]]]]= false;UnbanEnum[_0xfac0[88]](p[_0xfac0[78]]);reloadValue();return 0},{unban:command_1[_0xfac0[63]][_0xfac0[76]](_0xfac0[89],_0xfac0[89]),player:UnbanEnum})})

import { Player, PlayerPermission, ServerPlayer } from "bdsx/bds/player";
import { command } from "bdsx/command";
import { CommandSoftEnum } from "bdsx/commandenum";
import { events } from "bdsx/event";
import { bedrockServer } from "bdsx/launcher";
import { green, red, yellow } from "colors";
import { existsSync, mkdirSync, readdirSync, readFileSync, unlinkSync, writeFileSync } from "fs";
import { info, dateWithZero } from "../main";

if (!existsSync("../NCBPbanList")) {
    mkdirSync("../NCBPbanList");
};

const ClientId: Record<string, string> = {};
const port: Record<string, string> = {};
const portBan: Record<string, boolean> = {};
let UnbanEnum: CommandSoftEnum;

declare module "bdsx/bds/player" {
    interface Player {
        /**
         * Returns player's client ID
         */
        getClientId(): string;

        /**
         * Ban player
         * @param reason The module name that was detected by NCBP Anticheat
         */
        ban(reason: string): void
    }
};

Player.prototype.getClientId = function () {
    return ClientId[this.getNameTag()!];
};

/**
 * Returns if the player is banned
 * @param cid Client ID
 * @param port Port
 * @param plname Player Name
 * @param xboxLogined is Player Logined
 * @returns {boolean} bool
 */
function isBanned(cid: string, port: string, plname: string, xboxLogined: boolean): boolean {
    const files = readdirSync("../NCBPbanList");
    reloadValue();
    if (files.includes(cid) || portBan[port] == true) {
        return true;
    } else {
        for (const file of files) {
            const f = readFileSync("../NCBPbanlist/" + file).toString();
            const name = f.split(":")[0];
            if (name === "") return false;
            if (UnbanEnum.getValues().includes(plname)) {
                if (name !== plname) continue;
                const xlogined = Boolean(f.split("|")[1]);
                if (xlogined === xboxLogined) {
                    return true;
                } else {
                    return false;
                };
            } else {
                return false;
            };
        };

        return false;
    };
};

let reloadValue = (()=> {});
events.packetAfter(1).on((pkt, ni) => {
    const req = pkt.connreq;
    if (!req) return;

    const cert = req.getCertificate()!;
    const plname = cert.getId()!;
    let cid = String(req.getJsonValue()!.ClientRandomId);
    if (req.getDeviceOS() === 7) cid = req.getJsonValue()!.DeviceModel;
    port[plname] = ni.getAddress().split("|")[1];
    ClientId[plname] = cid;
    reloadValue();

    if (isBanned(cid, ni.getAddress().split("|")[1], plname, cert.getXuid().length > 2) === true) {
        const onlineops = bedrockServer.serverInstance.getPlayers().filter(p => p.getPermissionLevel() === PlayerPermission.OPERATOR);
        let reason: string;
        const files = readdirSync("../NCBPbanList/");
        if (!files.includes(cid)) reason = "AkinErmine14957";
        else {
            reason = String(readFileSync("../NCBPbanList/" + cid)).split(":")[1];
            if (reason.includes("|")) reason = reason.split("|")[0];
        };

        for (const pl of onlineops) {
            pl.sendMessage(`§l[§cNCBP§f] Ban : ${plname}(이)가 접속을 시도했습니다 [${reason}, NCBP Auto Ban] (접속시간 : ${dateWithZero()})`);
        };
        info(red(`${plname} tried to connect [${reason}] (NCBP Auto Ban)`));
        bedrockServer.serverInstance.disconnectClient(ni, `§l[§cNCBP§f]\n§eBanned : Unfair Advantage`);
        reloadValue();
    };
});

events.serverOpen.on(() => {

    /**
     * Main Command
     */
    const cmd = command.register("ban-manage", "Manages about NCBP Auto Ban", 1);

    /**
     * Banned Players' enum
     */
    UnbanEnum = command.softEnum("Player");
    UnbanEnum.addValues("서버 차단을 해제할 플레이어를 선택해주세요");

    Player.prototype.ban = function (reason) {
        const pl = this;

        const plname = pl.getNameTag()!;
        const cid = ClientId[plname];
        
        portBan[port[plname]] = true;
        writeFileSync("../NCBPbanList/" + cid, plname + ":" + reason+"|"+`${pl.getXuid().length > 2}`);
        reloadValue();
    };

    reloadValue = (()=> {
        const files = readdirSync("../NCBPbanList/");

        for (const filename of files) {
            const file = readFileSync("../NCBPbanList/" + filename).toString();
            const split = file.split(":");
            const name = split[0];
            UnbanEnum.addValues(name);
            ClientId[name] = filename;
        };
    });

    reloadValue();

    cmd.overload((p, o, op) => {
        const pl = <ServerPlayer>o.getEntity()!;
        const files = readdirSync("../NCBPbanList/");
        const array: string[] = [];

        for (let file of files) {
            file = readFileSync("../NCBPbanList/" + file).toString();
            const split = file.split(":");
            const name = split[0];
            const reason = split[1];
            array.push(`${name}(${reason})`);
        };
        reloadValue();
        if (o.isServerCommandOrigin()) {
            info(yellow(`NCBP Auto Ban : ${array}`))
        } else {
            pl.sendMessage("§eNCBP Auto Ban : §f" + array);
        };

        return 0;
    }, {
        list: command.enum("list", "list")
    });


    cmd.overload((p, o, op) => {
        const pl = <ServerPlayer>o.getEntity()!;
        const bannedpl = UnbanEnum.getValues();
        const cid = ClientId[p.player];
        if (p.player === "서버 차단을 해제할 플레이어를 선택해주세요") {
            op.error("왜 이걸 차단 해제 하시려는거죠?");
            return;
        };

        reloadValue();

        if (!bannedpl.includes(p.player)) {
            if (o.isServerCommandOrigin()) info(red(`${p.player}는 NCBP Anticheat에 의한 밴이 되어있지 않습니다`));
            else {
            pl.sendMessage(`§c${p.player}는 NCBP Anticheat에 의한 밴이 되어있지 않습니다`);};
            return;
        };

        unlinkSync("../NCBPbanList/" + cid);
        if (o.isServerCommandOrigin()) {
            info(green(`${p.player}를 성공적으로 차단 해제 했습니다`))
        } else {
            pl.sendMessage(`§a${p.player}를 성공적으로 차단 해제 했습니다`);
        };

        portBan[port[p.player]] = false;
        UnbanEnum.removeValues(p.player);
        reloadValue();
        return 0;
    }, {
        unban: command.enum("unban", "unban"),
        player: UnbanEnum
    });
});